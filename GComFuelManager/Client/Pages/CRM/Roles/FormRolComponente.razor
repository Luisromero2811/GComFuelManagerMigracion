@page "/crm/roles/formulario"
@page "/crm/roles/formulario/{Id:int}"

@inject IRepositorio http
@inject SweetAlertService swal
@inject CRMRolPostValidator validator
@inject NavigationManager navigation
@attribute [Authorize(Roles = "Admin, CREAR_ROL, EDITAR_ROL")]

<AuthorizeView Roles="Admin, CREAR_ROL, EDITAR_ROL">
    <Authorized>
        <Card LoadingContent="loading_info">
            <Header>
                <div class="d-flex justify-content-between">
                    <b>Formulario de rol</b>
                    <NavLink class="g-1 btn gcom-bg-amarillo" href="crm/roles" Match="NavLinkMatch.All">
                        <i class="fa fa-solid fa-arrow-left" /> Volver
                    </NavLink>
                </div>
            </Header>
            <Body>
                <EditForm class="col-12 row gy-2 gx-3" Model="Rol" Context="FormRol" OnValidSubmit="Guardar">
                    <FluentValidationValidator Validator="validator" />
                    <ValidationSummary />

                    <div class="col-md-4 col-12">
                        <label>Nombre</label>
                        <InputText @bind-Value="Rol.Nombre" class="form-control" />
                        <ValidationMessage For="@(()=>Rol.Nombre)" />
                    </div>
                    <div class="col-12">
                        <label>Permisos de rol</label>
                        <SelectorMultiple T="CRMGrupoPermisoDTO" NoSeleccionado="PermisosNoSeleccionados" Seleccionados="PermisosSeleccionados">
                            <CustomNoSeleccionado Context="item">
                                <div>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item" @onclick="@(()=>SeleccionarTodo(item))" id="@item.Grupo">
                                            <b>@item.Grupo</b>
                                        </li>
                                        @foreach (var permiso in item.Permisos)
                                        {
                                            <li class="list-group-item ms-4" @onclick="@(()=>Seleccionar(item.Grupo, permiso))" id="@permiso.Nombre">
                                                @permiso.Nombre
                                            </li>
                                        }
                                    </ul>
                                </div>
                            </CustomNoSeleccionado>
                            <CustomSeleccionado Context="item">
                                <div>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item" @onclick="@(()=>NoSeleccionarTodo(item))" id="@item.Grupo">
                                            <b>@item.Grupo</b>
                                        </li>
                                        @foreach (var permiso in item.Permisos)
                                        {
                                            <li class="list-group-item ms-4" @onclick="@(()=>NoSeleccionar(item.Grupo, permiso))" id="@permiso.Nombre">
                                                @permiso.Nombre
                                            </li>
                                        }
                                    </ul>
                                </div>
                            </CustomSeleccionado>
                        </SelectorMultiple>
                    </div>
                    <div class="col-12">
                        <div class="col-md-4 col-12 d-flex">
                            <button type="submit" class="btn gcom-bg-amarillo col-12 mt-auto">
                                <i class="fa fa-solid fa-floppy-disk" />
                                Guardar
                                @if (loading_save)
                                {
                                    <SpinnerLoading />
                                }
                            </button>
                        </div>
                    </div>
                </EditForm>
            </Body>
        </Card>
    </Authorized>
    <NotAuthorized>
        <NoAutorizado />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public int Id { get; set; }

    CRMRolPostDTO Rol = new();
    List<CRMGrupoPermisoDTO> PermisosNoSeleccionados = new();
    List<CRMGrupoPermisoDTO> PermisosSeleccionados = new();

    bool loading_info = false;
    bool loading_save = false;

    protected override async Task OnInitializedAsync()
    {
        await ObtenerPermisosNoSeleccionados();
        await ObtenerPermisosSeleccionados();

        if (Id != 0)
            await Obtener();
    }

    private async Task ObtenerPermisosNoSeleccionados()
    {
        try
        {
            var response = await http.Get<List<CRMGrupoPermisoDTO>>($"api/crmpermiso/no/{Id}");
            if (response.Error)
            {
                var message = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", message, SweetAlertIcon.Error);
            }
            else
            {
                PermisosNoSeleccionados = response.Response;
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }

    }

    private async Task ObtenerPermisosSeleccionados()
    {
        try
        {
            var response = await http.Get<List<CRMGrupoPermisoDTO>>($"api/crmpermiso/{Id}");
            if (response.Error)
            {
                var message = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", message, SweetAlertIcon.Error);
            }
            else
            {
                PermisosSeleccionados = response.Response;
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }

    }

    private async Task Guardar()
    {
        try
        {
            PermisosSeleccionados.ForEach(x =>
            {
                Rol.Permisos.AddRange(x.Permisos);
            });

            loading_save = true;
            var response = await http.Post<CRMRolPostDTO>($"api/crmrol", Rol);
            if (response.Error)
            {
                loading_save = false;
                var message = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", message, SweetAlertIcon.Error);
            }
            else
            {
                loading_save = false;
                if (Id != 0)
                    navigation.NavigateTo("crm/roles", false);
                else
                    Rol = new();
            }
        }
        catch (Exception e)
        {
            loading_save = false;
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }

    private async Task Obtener()
    {
        try
        {
            loading_info = true;
            var response = await http.Get<CRMRolPostDTO>($"api/crmrol/{Id}");
            if (response.Error)
            {
                loading_info = false;
                var message = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", message, SweetAlertIcon.Error);
            }
            else
            {
                loading_info = false;
                Rol = response.Response;
            }
        }
        catch (Exception e)
        {
            loading_info = false;
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }

    }

    private void SeleccionarTodo(CRMGrupoPermisoDTO grupo)
    {
        PermisosNoSeleccionados.Remove(grupo);
        if (!PermisosSeleccionados.Any(x => x.Grupo.Equals(grupo.Grupo)))
            PermisosSeleccionados.Add(grupo);
        else
            PermisosSeleccionados.First(x => x.Grupo.Equals(grupo.Grupo)).Permisos.AddRange(grupo.Permisos);
    }

    private void Seleccionar(string grupo, CRMPermisoDTO permiso)
    {
        PermisosNoSeleccionados.First(x => x.Grupo.Equals(grupo))
        .Permisos.Remove(permiso);

        if (!PermisosSeleccionados.Any(x => x.Grupo.Equals(grupo)))
        {
            PermisosSeleccionados.Add(new()
                {
                    Grupo = grupo,
                    Permisos = new() { permiso }
                });
        }
        else
            PermisosSeleccionados.First(x => x.Grupo.Equals(grupo)).Permisos.Add(permiso);
    }

    private void NoSeleccionarTodo(CRMGrupoPermisoDTO grupo)
    {
        PermisosSeleccionados.Remove(grupo);
        if (!PermisosNoSeleccionados.Any(x => x.Grupo.Equals(grupo.Grupo)))
            PermisosNoSeleccionados.Add(grupo);
        else
            PermisosNoSeleccionados.First(x => x.Grupo.Equals(grupo.Grupo)).Permisos.AddRange(grupo.Permisos);
    }

    private void NoSeleccionar(string grupo, CRMPermisoDTO permiso)
    {
        PermisosSeleccionados.First(x => x.Grupo.Equals(grupo))
        .Permisos.Remove(permiso);

        if (!PermisosNoSeleccionados.Any(x => x.Grupo.Equals(grupo)))
        {
            PermisosNoSeleccionados.Add(new()
                {
                    Grupo = grupo,
                    Permisos = new() { permiso }
                });
        }
        else
            PermisosNoSeleccionados.First(x => x.Grupo.Equals(grupo)).Permisos.Add(permiso);
    }
}
