@page "/ETA"
@inject IRepositorio repositorio
@inject SweetAlertService swal
@inject IJSRuntime JS
@inject HttpClient Http
@inject NavigationManager navigationManager
@inject TooltipService ts
@inject NotificationService ns

@attribute [Authorize(Roles = "Admin, Administrador Sistema, Direccion, Gerencia, Ejecutivo de Cuenta Comercial, Programador, Coordinador, Analista Suministros, Auditor, Capturista Recepcion Producto, Ejecutivo de Cuenta Operativo, Comprador")]


<h4><b>ETA</b></h4>
<!--Primer formulario para tiempo estimado de llegada del pedido-->
<div class="col-12 card shadow">
    <div class="card-body">
        <EditForm Model="Ordenes" class="row">
            <AuthorizeView Roles="Admin, Administrador Sistema, Coordinador, Capturista Recepcion Producto, Comprador" Context="Filter">
                <div class="row d-flex g-3">
                    <div class="row">
                        <div class="col-3">
                            <label>Número de Bol:</label>
                            <RadzenNumeric Change="@GetEta" class="form-control" @bind-value="@Ordenes.Bol" TValue="int?" />
                        </div>
                        @* <div class="col-1 mt-4">
                            <button class="btn gcom-bg-amarillo col-12">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            </button>
                            </div> *@
                    </div>
                </div>
            </AuthorizeView>
            <AuthorizeView Roles="Admin, Administrador Sistema, Coordinador" Context="Eta">
                <div class="row d-flex g-3">
                    <div class="row">
                        <div class="col-4">
                            <label>Fecha documentación:</label>
                            <RadzenDatePicker class="col-12" ShowTime="true" Culture="CultureInfo.CurrentCulture" ShowSeconds="true"
                                              @bind-Value="Ordenes.FchDoc"></RadzenDatePicker>
                        </div>
                        <div class="col-4">
                            <label>ETA:</label>
                            <RadzenNumeric Change="@AddTime" class="form-control" @bind-value="@Ordenes.EtaNumber" TValue="int" />
                        </div>
                        <div class="col-4">
                            <label>Fecha de llegada estimada:</label>
                            <RadzenDatePicker class="col-12" ShowTime="true" Culture="CultureInfo.CurrentCulture" ShowSeconds="true"
                                              @bind-Value="Ordenes.Fchlleest"></RadzenDatePicker>
                        </div>
                    </div>
                </div>
            </AuthorizeView>
            <div class="row d-flex g-3">
                <div class="row">
                    <AuthorizeView Roles="Admin, Administrador Sistema, Coordinador" Context="Trayectos">
                        <div class="col-4">
                            <label>En trayecto:</label>
                            <InputSelect @bind-Value="@Ordenes.CodEst" class="form-select" TValue="byte">
                                <option value=20>NO</option>
                                <option value=26>SI</option>
                            </InputSelect>
                        </div>
                    </AuthorizeView>
                    <AuthorizeView Roles="Admin, Administrador Sistema, Coordinador, Capturista Recepcion Producto" Context="Equipo">
                        <div class="col-4">
                            <label>Equipo:</label>
                            <div>
                                @if (Ordenes.Orden != null)
                                {
                                    @if (Ordenes.Orden.Tonel != null)
                                    {
                                        <p>
                                            @Ordenes.Orden.Tonel.Veh
                                        </p>
                                    }
                                    else
                                    {
                                        <p>No se encontro una unidad</p>
                                    }
                                }
                            </div>
                        </div>
                    </AuthorizeView>
                </div>
            </div>



            <AuthorizeView Roles="Admin, Administrador Sistema, Capturista Recepcion Producto, Comprador" Context="EtaReal">
                <!--btn look-->
                <div class="row d-flex g-3">
                    <div class="row justify-content-end">
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <label>Fecha real de llegada a destino:</label>
                        <RadzenDatePicker class="col-12" ShowTime="true" Culture="CultureInfo.CurrentCulture" ShowSeconds="true"
                                          @bind-Value="Ordenes.Fchrealledes"></RadzenDatePicker>
                    </div>
                    <div class="col-6" @onmouseenter="@(args => ShowToolTips(infoIcons))" @ref="infoIcons">
                        <label>Cantidad de litros recibidos:</label><i class="fa-solid fa-circle-info fa-xs"></i>
                        <RadzenNumeric class="form-control" @bind-Value="Ordenes.Litent" TValue="double?" MaxLenght="30" />
                        @*<InputNumber @bind-Value="Ordenes.Litent" class="form-control" FormatString="N0"/>*@
                        <!--Format="#,0.00" Format="n2"-->
                    </div>
                </div>
                <div class="row g-3 mt-1 mb-2">
                    <div class="col-6">
                        <label>Observaciones</label>
                        <InputTextArea class="form-control" @bind-Value="Ordenes.Obs" MaxLenght="260" Placeholder="Máximo de 260 caracteres"></InputTextArea>
                    </div>
                </div>
            </AuthorizeView>
            <AuthorizeView Roles="Admin, Administrador Sistema, Capturista Recepcion Producto, Coordinador, Comprador" Context="Actions">
                <div class="row d-flex g-3">
                    <div class="row justify-content-end">
                        <div class="col-3 mt-3 mb-3" @onmouseenter="@(args => ShowToolTip(infoIcon))" @ref="infoIcon">
                            <button class="btn gcom-bg-amarillo col-12" @onclick="SendOrdenEta" type="button">
                                <i class="fa-solid fa-floppy-disk"></i> <b>Guardar</b>
                            </button>
                        </div>
                    </div>
                </div>
            </AuthorizeView>
        </EditForm>
    </div>
</div>
<AuthorizeView Roles="Admin, Administrador Sistema, Direccion, Gerencia, Ejecutivo de Cuenta Comercial, Programador, Coordinador, Analista Suministros, Analista Credito , Auditor, Capturista Recepcion Producto, Ejecutivo de Cuenta Operativo" Context="Exportar">
    <!--Segundo formulario para exportación de ETA-->
    <div class="col-12 card shadow mt-3 mb-5">
        <div class="card-body">
            <EditForm Model="@ordenEmbarque">
                <div class="row g3 d-flex">
                    <div class="row">
                        <label><b>Reporte</b></label>
                        <div class="col-md-3" @onmouseenter="@(args => ShowToolsTips(infosIcon))" @ref="infosIcon">
                            <label>Fecha de inicio:</label><i class="fa-solid fa-circle-info fa-xs"></i>
                            <InputDate class="form-control col-12" @bind-Value="@fechas.DateInicio" />
                        </div>
                        <div class="col-md-3">
                            <label>Fecha final</label>
                            <InputDate class="form-control col-12" @bind-Value="@fechas.DateFin" />
                        </div>
                        <div class="col-md-3" @onmouseenter="@(args => ShowToolsTip(infossIcon))" @ref="infossIcon">
                            <label>Tipo de Venta (Solo Delivery)</label><i class="fa-solid fa-circle-info fa-xs"></i>
                            <InputSelect class="form-select" @bind-Value="@fechas.TipVenta">
                                <option>--Seleccione una opcion</option>
                                @if (TpVenta is null)
                                {
                                    <option disabled> Cargando ...</option>
                                }
                                else if (TpVenta.Count == 0)
                                {
                                    <option disabled> No hay tipos de venta</option>
                                }
                                else
                                {
                                    foreach (var item in TpVenta)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }

                            </InputSelect>
                        </div>
                        <div class="col-md-3">
                            <label></label>
                            <button class="btn gcom-bg-amarillo col-12" @onclick="@MostrarEtaFecha"><i class="fa fa-solid fa-eye"></i> <b>Mostrar órdenes</b></button>
                        </div>
                    </div>
                </div>
                <div class="col-12 card shadow mt-3 mb-5">
                    <div class="card-body">

                        <div class="col-12 mb-2 table-responsive ancho" style="height:340px; resize: both;">
                            <RadzenDataGrid TItem="EtaDTO" Data="@ordens" AllowColumnResize="true" AllowVirtualization="true" AllowPickAllColumns="true" GridLines="DataGridGridLines.Both" class="rz-my-12 auto"
                                            Style="height:600px;" ColumnResized="@(()=>Grid.Reset())" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" IsLoading="loadingFiltro" Density="Density.Default"
                                            @ref="@Grid" AllowColumnPicking="true" AllowSorting="true" AllowFiltering="true" Culture="CultureInfo.CurrentCulture" @bind-Settings="@Settings">
                                <Columns>
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Referencia" Property="Referencia" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Fecha de Programa" Property="FechaPrograma" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Estatus de Orden" Property="EstatusOrden" Filterable="false" Width="90px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Fecha de Carga" Property="FechaCarga" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="BOL" Property="Bol" Filterable="false" Width="80px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Tipo de Venta" Property="DeliveryRack" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Cliente" Property="Cliente" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Destino" Property="Destino" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Producto" Property="Producto" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Volumen Natural" Property="Volms" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Volumen Cargado" Property="Vols" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Transportista" Property="Transportista" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Unidad" Property="Unidad" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Operador" Property="Operador" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Fecha Documentacion" Property="FechaDoc" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Horas estimadas de viaje" Property="Eta" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="ETA" Property="FechaEst" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Estado de Orden" Property="Trayecto" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Observaciones" Property="Observaciones" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Fecha Real de Llegada" Property="FechaRealEta" Filterable="false" Width="100px" Frozen="true" />
                                    <RadzenDataGridColumn TItem="EtaDTO" Title="Litros Entregados" Property="EntLit" Filterable="false" Width="100px" Frozen="true" />
                                </Columns>
                            </RadzenDataGrid>
                        </div>
                        <div class="row justify-content-end me-3 mt-3 mb-3">
                            <div class="col-3 mt-3 mb-3">
                                <button class="btn gcom-bg-amarillo col-12" @onclick="@ExportExcel"><img src="img/sobresalir.png" class="img-fluid" style="width:16px; height:auto;" /><b>Exportar</b></button>
                            </div>
                        </div>

                    </div>
                </div>
            </EditForm>
        </div>
    </div>
</AuthorizeView>

<style type="text/css">
    .ancho{
          width: @TotalWidth;
    }
    tr:hover {
        background-color: #FFF633;
    }

    tr:active {
        background-color: #FFF633;
    }

    table.asignar {
        table-layout: auto;
        width: auto;
    }

    .sticky-column {
        position: sticky;
        left: 0;
        z-index: 1;
        background-color: white;
    }

        .sticky-column, .sticky-column + th, .sticky-column + td {
            min-width: 180px;
        }
</style>

@code {

    string TotalWidth = string.Empty;

    //Element References
    ElementReference infossIcon;
    ElementReference infosIcon;
    ElementReference infoIcons;
    private ElementReference BOLInput;
    //Tooltips de reportes
    void ShowToolsTip(ElementReference elementReference, TooltipOptions options = null!) => ts.Open(elementReference, "En caso de buscar ordenes de tipo Delivery, seleccione un rango de fechas y escoja una opción de venta", options);
    void ShowToolsTips(ElementReference elementReference, TooltipOptions optionss = null!) => ts.Open(elementReference, "En caso de buscar Ordenes con Tipo de Venta RACK, solo filtre entre un rango de fechas", optionss);
    void ShowToolTips(ElementReference elementReference, TooltipOptions option = null!) => ts.Open(elementReference, "Favor de de utilzar formato de separadores de miles. Ejemplo: 11.000,00 = Once mil", option);

    private RadzenDataGrid<EtaDTO>? Grid = new RadzenDataGrid<EtaDTO>();
    bool loadingFiltro = false;
    //Obtención de datos de la tabla Orden enlistados
    private Orden ordenEmbarque { get; set; } = new Orden();
    private List<EtaDTO> ordens { get; set; } = null!;
    private List<string> TpVenta { get; set; } = new List<string> { "Interno", "Externo" };

    Cliente cliente { get; set; } = new Cliente();
    //Instancia a modelo de OrdEmbDet
    OrdEmbDet Ordenes { get; set; } = new OrdEmbDet()
    {
        Orden = new Orden()
        {
            Estado = new Estado(),
            Tonel = new Tonel()
        }
    };
    //Instancia a DTO
    FechasF fechas = new FechasF();
    EtaDTO etaDto = new EtaDTO();

    ElementReference infoIcon;

    int time;

    void ShowToolTip(ElementReference elementReference, TooltipOptions options = null!) => ts.Open(elementReference, "Este boton funciona simultaneamente para Editar como para Guardar el ETA Real", options);

    bool isClose = false;
    int width = 0;

    DataGridSettings _settings;
    DataGridSettings Settings { get { return _settings; } set { if (_settings != value) { _settings = value; InvokeAsync(SaveStateAsync); } } }

    private async Task SaveStateAsync()
    {
        try
        {
            await Task.CompletedTask;
            await JS.SetItemLocalStorage("settingsSeguimiento", JsonConvert.SerializeObject(Settings));
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var cm = await JS.GetItemLocalStorage("CloseMenu");
        if (!string.IsNullOrEmpty(cm))
            isClose = bool.Parse(cm);

        if (isClose)
            width = await JS.InvokeAsync<int>("eval", "window.innerWidth") - 110;
        else
            width = await JS.InvokeAsync<int>("eval", "window.innerWidth") - 360;

        if (width < 0)
            width = 500;
        TotalWidth = $"{width}px";
    }

    private void Message(NotificationMessage message)
    {
        ns.Notify(message);
    }

    public async Task GetOrden()
    {
        try
        {
            //Tiempo Estimado de Arribo
            etaDto.Bol = Ordenes.Bol;
            var responseHttp = await repositorio.Post<EtaDTO, OrdEmbDet>($"api/Eta/Filtro", etaDto);
            if (responseHttp.Error)
            {
                var respuestaHttp = await responseHttp.ObtenerMensajeError();
                await swal.FireAsync("Error", respuestaHttp, SweetAlertIcon.Error);
            }
            else
            {
                Ordenes = responseHttp.Response;
                StateHasChanged();
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }

    public async Task SendOrdenEta()
    {
        try
        {

            if (Ordenes.Bol != 0 && Ordenes.Bol != null)
            {
                if (Ordenes?.Orden?.Codest != 0)
                {
                    Ordenes.Orden!.BatchId = Ordenes.Bol;

                    var responseHttp = await repositorio.Post<OrdEmbDet, OrdEmbDet>($"api/eta", Ordenes);
                    if (responseHttp.Error)
                    {
                        var respuestaHttp = await responseHttp.ObtenerMensajeError();
                        await swal.FireAsync("Error", respuestaHttp, SweetAlertIcon.Error);
                    }
                    else
                    {
                        Message(new NotificationMessage
                        {
                            Severity = NotificationSeverity.Success,
                            Summary = "Eta registrado",
                            Detail = $"Se ha registrado el eta correctamente",
                            Duration = 5000
                        });
                        Ordenes = responseHttp.Response;
                    }
                }
                else
                    await swal.FireAsync("Alerta", "Selecione un valor valido para En Trayecto.", SweetAlertIcon.Warning);
            }
            else
                await swal.FireAsync("Alerta", "Ingrese un BOL valido.", SweetAlertIcon.Warning);
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }

    public async Task MostrarEtaFecha()
    {
        try
        {
            var responseHttp = await repositorio.Post<FechasF, List<EtaDTO>?>($"api/Eta/Etareporte", fechas);
            if (responseHttp.Error)
            {
                var message = await responseHttp.ObtenerMensajeError();
                await swal.FireAsync("Error", message, SweetAlertIcon.Error);
            }
            else
            {
                ordens = responseHttp.Response;
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }

    public async Task ExportExcel()
    {
        try
        {
            var responseHttp = await repositorio.Post<FechasF, List<EtaDTO>?>($"api/Eta/Etareporte", fechas);
            if (responseHttp.Error)
            {
                var respuestaHttp = await responseHttp.ObtenerMensajeError();
                await swal.FireAsync("Error", respuestaHttp, SweetAlertIcon.Error);
            }
            else
            {
                ordens = responseHttp.Response;
                //Licencia para guardado de Excel
                ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
                //Generacion de Excel
                var excel = new ExcelPackage();
                var worksheet = excel.Workbook.Worksheets.Add("ETA");
                worksheet.Columns.Width = 49;
                worksheet.Columns.AutoFit();
                //Formación de Excel
                var tablebody = worksheet.Cells["A1:A1"].LoadFromCollection(
                    ordens
                  , true);
                tablebody.Style.Font.Bold = true;
                tablebody.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                var header = worksheet.Cells["A1:T1"];
                header.Style.Fill.PatternType = ExcelFillStyle.Solid;
                header.Style.Fill.BackgroundColor.SetColor(Color.LightGray);
                //Guardar Excell
                await JS.GuardarComo($"ETA_{DateTime.Now.ToString("yyyyy-MM-dd hh:mm:ss")}.xlsx", excel.GetAsByteArray());
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }

    public async Task GetEta()
    {
        try
        {
            Console.WriteLine(Ordenes.Bol);
            if (Ordenes.Bol != 0)
            {
                var responseHttp = await repositorio.Get<OrdEmbDet>($"api/Eta/{Ordenes.Bol}");
                if (responseHttp.Error)
                {
                    var respuestaHttp = await responseHttp.ObtenerMensajeError();
                    await swal.FireAsync("Error", respuestaHttp, SweetAlertIcon.Error);
                }
                else
                {
                    Message(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "Buscando...",
                        Detail = $"Buscando orden con bol {Ordenes.Bol}",
                        Duration = 5000
                    });
                    if (Ordenes.Cod != 0)
                    {
                        if (responseHttp.Response.Cod != 0)
                            Ordenes = responseHttp.Response ?? new OrdEmbDet();
                        else
                        {
                            Ordenes.Cod = 0;
                            Ordenes.Bol = responseHttp.Response.Bol;
                            Ordenes.Orden = responseHttp.Response.Orden;
                        }
                    }
                    else
                        Ordenes = responseHttp.Response ?? new OrdEmbDet();

                    StateHasChanged();
                }
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
            throw e;
        }
    }

    private void AddTime()
    {
        if (Ordenes.EtaNumber >= 0)
            Ordenes.Fchlleest = Ordenes.FchDoc?.AddHours(Ordenes.EtaNumber);
    }
}

