@page "/porcentaje/cierre"

@inject IRepositorio repositorio
@inject SweetAlertService Swal
@inject IJSRuntime js
@inject NotificationService ns

@attribute [Authorize(Roles = "Admin, Administrador Sistema, Gestion de Transporte")]

<h3>Porcentaje para calculo de cierre</h3>

<div class="card col-12 shadow-sm">
    <div class="card-body">
        <div class="col-12 row">
            <div class="col-8">
                <label class="form-label">Porcentaje</label>
                <RadzenNumeric @bind-Value="Porcentaje.Porcen" Min="1" Max="99" class="col-12" MaxLenght="4"/>
            </div>
            <div class="col-4 d-flex">
                <button class="col-12 btn gcom-bg-amarillo mt-auto" @onclick="@SendPercent">
                    <i class="fa-solid fa-percent"></i>
                    @if (loading)
                    {
                        <SpinnerLoading/>
                    }
                </button>
            </div>
        </div>
        <div class="col-12 text-muted font-monospace">
            <p>*Ejemplo:*</p>
            <p>Volumen disponible: 124,000</p>
            <p>Promedio de cargas: 31,000</p>
            <p>124,000(volumen disponible) * .90(Porcentaje guardado) = 111,600</p>
            <p>31,000(promedio de carga) es mayor a 111,600(volumen calculado por el porcentaje) = no (el cierre sigue activo)</p>
        </div>
    </div>
</div>

@code {
    Porcentaje Porcentaje { get; set; } = new Porcentaje();
    bool loading = false;
    protected override async Task OnInitializedAsync()
    {
        await GetPercent();
    }

    private async Task GetPercent()
    {
        try
        {
            loading = true;
            var responseHttp = await repositorio.Get<Porcentaje>($"api/porcentaje/cierre");
            if (responseHttp.Error)
            {
                var respuestaHttp = await responseHttp.ObtenerMensajeError();
                await Swal.FireAsync("Error", respuestaHttp, SweetAlertIcon.Error);
                loading = false;
            }
            else
            {
                Porcentaje = responseHttp.Response;
                loading = false;
            }
        }
        catch (Exception e)
        {
            await Swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
            loading = false;
        }
    }

    private async Task SendPercent()
    {
        try
        {
            if (Porcentaje.Porcen != 0 && Porcentaje.Porcen != null)
            {
                var responseHttp = await repositorio.Post<Porcentaje, Porcentaje>($"api/porcentaje/cierre", Porcentaje);
                if (responseHttp.Error)
                {
                    var respuestaHttp = await responseHttp.ObtenerMensajeError();
                    await Swal.FireAsync("Error", respuestaHttp, SweetAlertIcon.Error);
                }
                else
                {
                    await Swal.FireAsync("Exito", "El porcentaje ha sido registrado con exito", SweetAlertIcon.Success);
                }
            }
            else
            {
                await Swal.FireAsync("Alerta", "Ingrese un porcentaje valido", SweetAlertIcon.Warning);
            }
        }
        catch (Exception e)
        {
            await Swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }

}
